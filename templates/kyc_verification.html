<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Identidad KYC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        .step-active { @apply bg-blue-600 text-white; }
        .step-completed { @apply bg-green-600 text-white; }
        .step-inactive { @apply bg-gray-300 text-gray-600; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="kycVerification()">
        
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-600 rounded-full mb-4">
                <i class="fas fa-shield-alt text-3xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Verificaci√≥n de Identidad</h1>
            <p class="text-gray-600 text-lg">Complete el proceso paso a paso para verificar su identidad</p>
        </div>

        <!-- Progress Steps -->
        <div class="flex justify-center mb-12">
            <div class="flex items-center space-x-4">
                <!-- Step 1 -->
                <div class="flex items-center">
                    <div :class="getStepClass(1)" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg transition-all duration-300">
                        <i x-show="currentStep > 1" class="fas fa-check"></i>
                        <span x-show="currentStep <= 1">1</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-gray-700">Datos y DNI</span>
                </div>
                
                <div class="w-8 h-1 bg-gray-300 rounded"></div>
                
                <!-- Step 2 -->
                <div class="flex items-center">
                    <div :class="getStepClass(2)" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg transition-all duration-300">
                        <i x-show="currentStep > 2" class="fas fa-check"></i>
                        <span x-show="currentStep <= 2">2</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-gray-700">Selfie</span>
                </div>
                
                <div class="w-8 h-1 bg-gray-300 rounded"></div>
                
                <!-- Step 3 -->
                <div class="flex items-center">
                    <div :class="getStepClass(3)" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg transition-all duration-300">
                        <i x-show="currentStep > 3" class="fas fa-check"></i>
                        <span x-show="currentStep <= 3">3</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-gray-700">Video</span>
                </div>
                
                <div class="w-8 h-1 bg-gray-300 rounded"></div>
                
                <!-- Step 4 -->
                <div class="flex items-center">
                    <div :class="getStepClass(4)" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg transition-all duration-300">
                        <i x-show="currentStep > 4" class="fas fa-check"></i>
                        <span x-show="currentStep <= 4">4</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-gray-700">Resultado</span>
                </div>
            </div>
        </div>

        <!-- Main Content Card -->
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                
                <!-- PASO 1: Datos Personales y DNI -->
                <div x-show="currentStep === 1" class="p-8">
                    <div class="text-center mb-8">
                        <i class="fas fa-user-edit text-5xl text-blue-600 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Informaci√≥n Personal</h2>
                        <p class="text-gray-600">Complete sus datos y suba una foto de su DNI</p>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Formulario -->
                        <div class="space-y-6">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Apellidos</label>
                                    <input x-model="userData.lastName" type="text" placeholder="Ej: Garc√≠a L√≥pez" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre</label>
                                    <input x-model="userData.firstName" type="text" placeholder="Ej: Juan" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Documento</label>
                                    <input x-model="userData.documentNumber" type="text" placeholder="12345678X / AB123456C" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nacionalidad</label>
                                    <select x-model="userData.nationality" 
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Seleccionar pa√≠s</option>
                                        <option value="ESP">Espa√±a (DNI)</option>
                                        <option value="FRA">Francia (CNI)</option>
                                        <option value="ITA">Italia (CI)</option>
                                        <option value="PRT">Portugal (CC)</option>
                                        <option value="DEU">Alemania (Personalausweis)</option>
                                        <option value="GBR">Reino Unido (ID Card)</option>
                                        <option value="USA">Estados Unidos (ID Card)</option>
                                        <option value="MEX">M√©xico (INE)</option>
                                        <option value="ARG">Argentina (DNI)</option>
                                        <option value="COL">Colombia (CC)</option>
                                        <option value="PER">Per√∫ (DNI)</option>
                                        <option value="CHL">Chile (CI)</option>
                                        <option value="VEN">Venezuela (CI)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de nacimiento</label>
                                <input x-model="userData.birthDate" type="date" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de expedici√≥n</label>
                                    <input x-model="userData.issueDate" type="date" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de validez</label>
                                    <input x-model="userData.expiryDate" type="date" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>

                        <!-- Foto DNI -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-4">Foto del DNI (anverso)</label>
                            <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                                <i class="fas fa-id-card text-4xl text-blue-400 mb-4"></i>
                                <p class="text-gray-600 mb-4">Suba una foto clara de su DNI</p>
                                <input type="file" @change="handleDNIPhoto($event)" accept="image/*" class="hidden" id="dniPhoto">
                                <label for="dniPhoto" class="bg-blue-600 text-white px-6 py-3 rounded-lg cursor-pointer hover:bg-blue-700 transition-colors inline-block">
                                    <i class="fas fa-camera mr-2"></i>Seleccionar Foto
                                </label>
                            </div>
                            
                            <!-- Preview DNI -->
                            <div x-show="dniPhotoPreview" class="mt-4">
                                <img :src="dniPhotoPreview" class="w-full h-48 object-cover rounded-lg shadow-lg">
                            </div>

                            <!-- Validation Success Message -->
                            <div x-show="dniValidationPassed && extractedText" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-3 mt-1"></i>
                                    <div>
                                        <h4 class="font-semibold text-green-800 mb-2">‚úÖ Documento Validado Correctamente</h4>
                                        <p class="text-sm text-green-700 mb-3">Todos los datos coinciden. El documento es v√°lido y corresponde a la nacionalidad seleccionada.</p>
                                        <details class="text-xs">
                                            <summary class="cursor-pointer text-green-600 hover:text-green-800">Ver texto extra√≠do (debug)</summary>
                                            <pre x-text="extractedText" class="text-green-700 mt-2 p-2 bg-green-100 rounded whitespace-pre-wrap max-h-24 overflow-y-auto"></pre>
                                        </details>
                                    </div>
                                </div>
                            </div>

                            <!-- Validation Error Message -->
                            <div x-show="dniPhotoPreview && !processing && !dniValidationPassed && step1Result" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-exclamation-triangle text-red-600 mr-3 mt-1"></i>
                                    <div>
                                        <h4 class="font-semibold text-red-800 mb-2">‚ùå Error en Validaci√≥n del Documento</h4>
                                        <p class="text-sm text-red-700 mb-3">Los datos no coinciden con el documento. Corrige los datos o sube una foto m√°s clara y vuelve a hacer clic en "Continuar".</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end mt-8">
                        <button @click="nextStep()" :disabled="!canProceedStep1() || processing" 
                                :class="canProceedStep1() && !processing ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'"
                                class="px-8 py-3 text-white rounded-lg font-medium transition-colors">
                            <span x-show="!processing">Continuar <i class="fas fa-arrow-right ml-2"></i></span>
                            <span x-show="processing">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Validando documento...
                            </span>
                        </button>
                    </div>
                </div>

                <!-- PASO 2: Selfie con C√°mara -->
                <div x-show="currentStep === 2" class="p-8">
                    <div class="text-center mb-8">
                        <i class="fas fa-camera text-5xl text-green-600 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Captura tu Selfie</h2>
                        <p class="text-gray-600">Toma una foto de tu rostro para verificar tu identidad</p>
                    </div>

                    <div class="max-w-md mx-auto">
                        <!-- Camera Stream -->
                        <div class="relative bg-gray-100 rounded-lg overflow-hidden shadow-lg">
                            <video x-ref="selfieVideo" autoplay class="w-full h-80 object-cover" style="transform: scaleX(-1);"></video>
                            <canvas x-ref="selfieCanvas" class="hidden"></canvas>
                            
                            <!-- Overlay Guide -->
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div class="w-48 h-64 border-4 border-white rounded-full opacity-30"></div>
                            </div>
                        </div>

                        <!-- Camera Controls -->
                        <div class="mt-6 text-center space-y-4">
                            <!-- Bot√≥n de prueba de c√°mara -->
                            <div x-show="!cameraActive && !selfiePhoto" class="mb-4">
                                <button @click="testCamera()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors mr-2">
                                    <i class="fas fa-video mr-2"></i>Probar C√°mara
                                </button>
                                <button @click="startSelfieCamera()" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-camera mr-2"></i>Activar C√°mara
                                </button>
                            </div>

                            <div x-show="cameraActive && !selfiePhoto">
                                <button @click="takeSelfie()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-camera mr-2"></i>Tomar Selfie
                                </button>
                            </div>

                            <div x-show="selfiePhoto && !processingStep2 && !selfieVerificationAttempted">
                                <img :src="selfiePhoto" class="w-full h-80 object-cover rounded-lg shadow-lg mb-4">
                                <div class="flex space-x-4 justify-center">
                                    <button @click="retakeSelfie()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                        <i class="fas fa-redo mr-2"></i>Repetir
                                    </button>
                                    <button @click="nextStep()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-check mr-2"></i>Confirmar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Estado de carga para verificaci√≥n de selfie -->
                            <div x-show="processingStep2" class="text-center py-8">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                                    <i class="fas fa-cog fa-spin text-2xl text-blue-600"></i>
                                </div>
                                <p class="text-blue-600 font-medium mb-2">Verificando imagen...</p>
                                <p class="text-sm text-gray-500">Comparando con DNI, por favor espere...</p>
                            </div>
                            
                            <!-- Resultado de verificaci√≥n fallida -->
                            <div x-show="selfieVerificationAttempted && !selfieVerificationPassed" class="text-center py-8">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                                    <i class="fas fa-times text-2xl text-red-600"></i>
                                </div>
                                <p class="text-red-600 font-medium mb-2">Las im√°genes no coinciden</p>
                                <p class="text-sm text-gray-600 mb-4">Por favor, tome otra foto m√°s clara o con mejor iluminaci√≥n</p>
                                <button @click="retakeSelfie()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-redo mr-2"></i>Tomar otra foto
                                </button>
                            </div>
                            
                            <!-- Resultado de verificaci√≥n exitosa -->
                            <div x-show="selfieVerificationAttempted && selfieVerificationPassed" class="text-center py-8">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                                    <i class="fas fa-check text-2xl text-green-600"></i>
                                </div>
                                <p class="text-green-600 font-medium mb-2">¬°Verificaci√≥n exitosa!</p>
                                <p class="text-sm text-gray-600 mb-4">La imagen coincide correctamente con el DNI</p>
                                <button @click="currentStep++" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-arrow-right mr-2"></i>Continuar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button @click="previousStep()" class="px-6 py-3 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Anterior
                        </button>
                    </div>
                </div>

                <!-- PASO 3: Verificaci√≥n de Vida SIMPLIFICADA -->
                <div x-show="currentStep === 3" class="p-8">
                    <div class="text-center mb-8">
                        <i class="fas fa-video text-5xl text-purple-600 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Verificaci√≥n de Vida</h2>
                        <p class="text-gray-600">Grabe un video corto siguiendo las instrucciones</p>
                    </div>

                    <div class="max-w-2xl mx-auto">
                        <!-- Video Stream -->
                        <div class="relative bg-gray-100 rounded-lg overflow-hidden shadow-lg mb-6">
                            <video x-ref="recordVideo" autoplay class="w-full h-80 object-cover" style="transform: scaleX(-1);"></video>
                            
                            <!-- Recording Indicator -->
                            <div x-show="recording" class="absolute top-4 right-4 bg-red-600 text-white px-3 py-2 rounded-full shadow-lg">
                                <i class="fas fa-circle animate-pulse mr-2"></i>
                                <span class="text-sm font-bold">REC</span>
                            </div>
                            
                            <!-- Timer -->
                            <div x-show="recording" class="absolute top-4 left-4 bg-black bg-opacity-70 text-white px-3 py-2 rounded-full">
                                <span x-text="recordingTime" class="text-sm font-mono"></span>
                            </div>

                            <!-- Instrucci√≥n Actual -->
                            <div x-show="recording && currentMessage" class="absolute bottom-4 left-4 right-4">
                                <div class="bg-black bg-opacity-80 text-white p-4 rounded-lg text-center">
                                    <div class="text-2xl mb-2" x-text="currentIcon"></div>
                                    <h3 class="text-lg font-bold mb-1" x-text="currentMessage"></h3>
                                    <div class="bg-gray-600 rounded-full h-2 mb-2">
                                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" :style="`width: ${progress}%`"></div>
                                    </div>
                                    <p class="text-sm opacity-75" x-text="`${Math.ceil(timeRemaining)}s restantes`"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="text-center space-y-4">
                            <!-- Start Camera -->
                            <div x-show="!videoActive && !recordedVideo">
                                <button @click="startVideoCamera()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-camera mr-2"></i>Activar C√°mara
                                </button>
                            </div>

                            <!-- Start Recording -->
                            <div x-show="videoActive && !recording && !recordedVideo">
                                <div class="mb-6 p-4 bg-blue-50 rounded-lg border">
                                    <h4 class="font-bold text-blue-800 mb-2">üìã Instrucciones del Video:</h4>
                                    <ol class="text-sm text-blue-700 text-left space-y-1">
                                        <li>1. üëÄ Mire directamente a la c√°mara (5 segundos)</li>
                                        <li>2. ‚ÜîÔ∏è Gire la cabeza lentamente izquierda y derecha (5 segundos)</li>
                                        <li>3. üòä Sonr√≠a de forma natural (5 segundos)</li>
                                    </ol>
                                    <p class="text-xs text-blue-600 mt-2">Total: 15 segundos de grabaci√≥n</p>
                                </div>
                                <button @click="startRecording()" class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition-colors">
                                    <i class="fas fa-play mr-2"></i>Iniciar Grabaci√≥n
                                </button>
                            </div>

                            <!-- Processing -->
                            <div x-show="processing" class="py-8">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                                    <i class="fas fa-cog fa-spin text-2xl text-blue-600"></i>
                                </div>
                                <p class="text-blue-600 font-medium">Procesando video...</p>
                            </div>

                            <!-- Recorded Video -->
                            <div x-show="recordedVideo && !processing">
                                <video :src="recordedVideo" controls class="w-full h-64 rounded-lg shadow-lg mb-4"></video>
                                <div class="flex space-x-4 justify-center">
                                    <button @click="retakeVideo()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                                        <i class="fas fa-redo mr-2"></i>Repetir
                                    </button>
                                    <button @click="nextStep()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                        <i class="fas fa-check mr-2"></i>Continuar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button @click="previousStep()" class="px-6 py-3 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Anterior
                        </button>
                    </div>
                </div>

                <!-- PASO 4: Verificaci√≥n y Resultados -->
                <div x-show="currentStep === 4" class="p-8">
                    <div class="text-center mb-8">
                        <i class="fas fa-shield-check text-5xl text-indigo-600 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Verificaci√≥n en Proceso</h2>
                        <p class="text-gray-600">Analizando y comparando sus datos...</p>
                    </div>

                    <!-- Processing Animation -->
                    <div x-show="verifying" class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-4">
                            <i class="fas fa-cog fa-spin text-3xl text-blue-600"></i>
                        </div>
                        <p class="text-blue-600 font-medium">Procesando verificaci√≥n...</p>
                        <div class="mt-4 max-w-md mx-auto">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-1000" :style="`width: ${verificationProgress}%`"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2" x-text="verificationStep"></p>
                        </div>
                    </div>

                    <!-- Results -->
                    <div x-show="!verifying && verificationComplete">
                        <div class="max-w-2xl mx-auto">
                            <!-- Success/Failure Icon -->
                            <div class="text-center mb-8">
                                <div :class="verificationResult.success ? 'bg-green-100' : 'bg-red-100'" class="inline-flex items-center justify-center w-24 h-24 rounded-full mb-4">
                                    <i :class="verificationResult.success ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'" class="text-4xl"></i>
                                </div>
                                <h3 :class="verificationResult.success ? 'text-green-800' : 'text-red-800'" class="text-2xl font-bold mb-2" 
                                    x-text="verificationResult.success ? 'Verificaci√≥n Exitosa' : 'Verificaci√≥n Fallida'"></h3>
                                <p :class="verificationResult.success ? 'text-green-600' : 'text-red-600'" class="text-lg" 
                                   x-text="verificationResult.message"></p>
                            </div>

                            <!-- Detailed Results -->
                            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                                <h4 class="font-semibold text-gray-800 mb-4">üîç Detalles de la Verificaci√≥n:</h4>
                                
                                <!-- OCR Results -->
                                <div class="mb-6 p-4 bg-white rounded-lg border">
                                    <h5 class="font-medium text-gray-800 mb-3">üìÑ Datos Extra√≠dos del Documento (OCR):</h5>
                                    <div class="bg-gray-100 rounded-lg p-3 mb-3">
                                        <pre x-text="verificationResult.extracted_text || extractedText || 'Sin datos extra√≠dos'" class="text-sm text-gray-700 whitespace-pre-wrap max-h-32 overflow-y-auto"></pre>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-gray-600 mr-2">Estado OCR:</span>
                                        <span :class="(verificationResult.extracted_text || extractedText) ? 'text-green-600' : 'text-red-600'" class="font-medium">
                                            <i :class="(verificationResult.extracted_text || extractedText) ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                            <span x-text="(verificationResult.extracted_text || extractedText) ? 'Texto extra√≠do correctamente' : 'Error en extracci√≥n de texto'"></span>
                                        </span>
                                    </div>
                                </div>

                                <!-- Document Analysis Section -->
                                <div x-show="verificationResult && (verificationResult.document_analysis || verificationResult.success)" class="mb-6 p-4 bg-white rounded-lg border">
                                    <h5 class="font-medium text-gray-800 mb-4">üåç Verificaci√≥n de Documento Internacional</h5>
                                    
                                    <div class="space-y-4">
                                        <!-- Document Type & Country Verification -->
                                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                            <div class="flex justify-between items-center mb-2">
                                                <h6 class="font-medium text-blue-800">Tipo de Documento:</h6>
                                                <span class="text-blue-700 font-semibold" x-text="verificationResult.document_analysis.document_type"></span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-sm text-gray-600">Correspondencia con pa√≠s:</span>
                                                <span :class="verificationResult.document_analysis.country_match ? 'text-green-600' : 'text-red-600'" class="font-medium">
                                                    <i :class="verificationResult.document_analysis.country_match ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                                    <span x-text="verificationResult.document_analysis.country_match ? 'V√ÅLIDO' : 'NO V√ÅLIDO'"></span>
                                                </span>
                                            </div>
                                            <div x-show="!verificationResult.document_analysis.country_match" class="mt-2 text-sm text-red-600">
                                                ‚ö†Ô∏è El documento no corresponde al pa√≠s seleccionado
                                            </div>
                                        </div>

                                        <!-- Document Validity -->
                                        <div class="p-3 rounded-lg" :class="verificationResult.document_analysis.is_valid_document ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                                            <div class="flex items-center">
                                                <i :class="verificationResult.document_analysis.is_valid_document ? 'fas fa-certificate text-green-600' : 'fas fa-exclamation-triangle text-red-600'" class="mr-2"></i>
                                                <span class="font-medium" :class="verificationResult.document_analysis.is_valid_document ? 'text-green-800' : 'text-red-800'">
                                                    <span x-text="verificationResult.document_analysis.is_valid_document ? 'Documento V√°lido' : 'Documento Inv√°lido'"></span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Comparison Section -->
                                <div x-show="verificationResult && (verificationResult.data_matches || verificationResult.success)" class="mb-6 p-4 bg-white rounded-lg border">
                                    <h5 class="font-medium text-gray-800 mb-4">üìä Comparaci√≥n de Datos: Insertados vs Extra√≠dos</h5>
                                    
                                    <div class="space-y-3">
                                        <!-- Name comparison -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-3 border rounded-lg">
                                            <div>
                                                <span class="text-sm font-medium text-gray-600">Nombre:</span>
                                            </div>
                                            <div>
                                                <span class="text-sm text-blue-700">Insertado:</span>
                                                <p class="font-medium" x-text="userData.firstName + ' ' + userData.lastName"></p>
                                            </div>
                                            <div>
                                                <span class="text-sm text-purple-700">Extra√≠do:</span>
                                                <p class="font-medium" x-text="verificationResult.extracted_data?.name || 'No extra√≠do'"></p>
                                                <span :class="verificationResult.data_matches?.name ? 'text-green-600' : 'text-red-600'" class="text-sm">
                                                    <i :class="verificationResult.data_matches?.name ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                    <span x-text="verificationResult.data_matches?.name ? 'Coincide' : 'No coincide'"></span>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Document Number comparison -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-3 border rounded-lg">
                                            <div>
                                                <span class="text-sm font-medium text-gray-600">N√∫mero de Documento:</span>
                                            </div>
                                            <div>
                                                <span class="text-sm text-blue-700">Insertado:</span>
                                                <p class="font-medium" x-text="userData.documentNumber"></p>
                                            </div>
                                            <div>
                                                <span class="text-sm text-purple-700">Extra√≠do:</span>
                                                <p class="font-medium" x-text="verificationResult.extracted_data?.document_number || 'No extra√≠do'"></p>
                                                <span :class="verificationResult.data_matches?.document_number ? 'text-green-600' : 'text-red-600'" class="text-sm">
                                                    <i :class="verificationResult.data_matches?.document_number ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                    <span x-text="verificationResult.data_matches?.document_number ? 'Coincide' : 'No coincide'"></span>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Birth Date comparison -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-3 border rounded-lg">
                                            <div>
                                                <span class="text-sm font-medium text-gray-600">Fecha Nacimiento:</span>
                                            </div>
                                            <div>
                                                <span class="text-sm text-blue-700">Insertado:</span>
                                                <p class="font-medium" x-text="userData.birthDate"></p>
                                            </div>
                                            <div>
                                                <span class="text-sm text-purple-700">Extra√≠do:</span>
                                                <p class="font-medium" x-text="verificationResult.extracted_data?.birthdate || 'No extra√≠do'"></p>
                                                <span :class="verificationResult.data_matches?.birthdate ? 'text-green-600' : 'text-red-600'" class="text-sm">
                                                    <i :class="verificationResult.data_matches?.birthdate ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                    <span x-text="verificationResult.data_matches?.birthdate ? 'Coincide' : 'No coincide'"></span>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Issue Date comparison -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-3 border rounded-lg">
                                            <div>
                                                <span class="text-sm font-medium text-gray-600">Fecha Expedici√≥n:</span>
                                            </div>
                                            <div>
                                                <span class="text-sm text-blue-700">Insertado:</span>
                                                <p class="font-medium" x-text="userData.issueDate"></p>
                                            </div>
                                            <div>
                                                <span class="text-sm text-purple-700">Extra√≠do:</span>
                                                <p class="font-medium" x-text="verificationResult.extracted_data?.issue_date || 'No extra√≠do'"></p>
                                                <span :class="verificationResult.data_matches?.issue_date ? 'text-green-600' : 'text-red-600'" class="text-sm">
                                                    <i :class="verificationResult.data_matches?.issue_date ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                    <span x-text="verificationResult.data_matches?.issue_date ? 'Coincide' : 'No coincide'"></span>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Expiry Date comparison -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-3 border rounded-lg">
                                            <div>
                                                <span class="text-sm font-medium text-gray-600">Fecha Validez:</span>
                                            </div>
                                            <div>
                                                <span class="text-sm text-blue-700">Insertado:</span>
                                                <p class="font-medium" x-text="userData.expiryDate"></p>
                                            </div>
                                            <div>
                                                <span class="text-sm text-purple-700">Extra√≠do:</span>
                                                <p class="font-medium" x-text="verificationResult.extracted_data?.expiry_date || 'No extra√≠do'"></p>
                                                <span :class="verificationResult.data_matches?.expiry_date ? 'text-green-600' : 'text-red-600'" class="text-sm">
                                                    <i :class="verificationResult.data_matches?.expiry_date ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                    <span x-text="verificationResult.data_matches?.expiry_date ? 'Coincide' : 'No coincide'"></span>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Country/Nationality comparison -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-3 border rounded-lg">
                                            <div>
                                                <span class="text-sm font-medium text-gray-600">Pa√≠s/Nacionalidad:</span>
                                            </div>
                                            <div>
                                                <span class="text-sm text-blue-700">Seleccionado:</span>
                                                <p class="font-medium" x-text="userData.nationality"></p>
                                            </div>
                                            <div>
                                                <span class="text-sm text-purple-700">Del Documento:</span>
                                                <p class="font-medium" x-text="verificationResult.extracted_data?.nationality || 'No extra√≠do'"></p>
                                                <span :class="verificationResult.data_matches?.country ? 'text-green-600' : 'text-red-600'" class="text-sm">
                                                    <i :class="verificationResult.data_matches?.country ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                    <span x-text="verificationResult.data_matches?.country ? 'Coincide' : 'No coincide'"></span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Summary of data matching -->
                                    <div class="mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                                            <span class="font-medium text-blue-800">Resumen de Verificaci√≥n de Datos</span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div class="flex items-center">
                                                <span class="text-gray-600 mr-2">Nombre:</span>
                                                <i :class="verificationResult.data_matches?.name ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="text-gray-600 mr-2">Documento:</span>
                                                <i :class="verificationResult.data_matches?.document_number ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="text-gray-600 mr-2">Nacimiento:</span>
                                                <i :class="verificationResult.data_matches?.birthdate ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="text-gray-600 mr-2">Expedici√≥n:</span>
                                                <i :class="verificationResult.data_matches?.issue_date ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="text-gray-600 mr-2">Validez:</span>
                                                <i :class="verificationResult.data_matches?.expiry_date ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="text-gray-600 mr-2">Pa√≠s:</span>
                                                <i :class="verificationResult.data_matches?.country ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                            </div>
                                        </div>
                                        <div class="mt-3 p-2 bg-white rounded border">
                                            <p class="text-sm text-gray-700" x-text="verificationResult.details || 'Verificaci√≥n completada'"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Face Comparison Results - MEJORADO CON DETALLES COMPLETOS -->
                                <div class="space-y-4">
                                    <!-- DNI Validation Results -->
                                    <div class="p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h5 class="font-medium text-gray-800 flex items-center">
                                                    <i class="fas fa-id-card text-blue-600 mr-2"></i>
                                                    üìÑ Validaci√≥n de Documento (Paso 1)
                                                </h5>
                                                <p class="text-sm text-gray-600">An√°lisis y extracci√≥n de datos del DNI/ID</p>
                                            </div>
                                            <div class="text-right">
                                                <span :class="getStatusClass(step1Result?.recommendation)" 
                                                      class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">
                                                    <i :class="getStatusIcon(step1Result?.recommendation)" class="mr-1"></i>
                                                    <span x-text="getStatusText(step1Result?.recommendation)"></span>
                                                </span>
                                                <div class="text-lg font-bold mt-1" 
                                                     :class="getConfidenceClass(step1Result?.confidence)" 
                                                     x-text="`${step1Result?.confidence || 0}%`"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- DNI Analysis Details -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                            <div class="space-y-2">
                                                <h6 class="text-sm font-semibold text-gray-700">An√°lisis del Documento:</h6>
                                                <div x-show="step1Result?.document_analysis" class="text-sm space-y-1">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Tipo de documento:</span>
                                                        <span class="font-medium" x-text="step1Result?.document_analysis?.document_type || 'No detectado'"></span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">V√°lido para pa√≠s:</span>
                                                        <span :class="step1Result?.document_analysis?.country_match ? 'text-green-600' : 'text-red-600'" 
                                                              class="font-medium flex items-center">
                                                            <i :class="step1Result?.document_analysis?.country_match ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                            <span x-text="step1Result?.document_analysis?.country_match ? 'S√ç' : 'NO'"></span>
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Documento v√°lido:</span>
                                                        <span :class="step1Result?.document_analysis?.is_valid_document ? 'text-green-600' : 'text-red-600'" 
                                                              class="font-medium flex items-center">
                                                            <i :class="step1Result?.document_analysis?.is_valid_document ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                                            <span x-text="step1Result?.document_analysis?.is_valid_document ? 'S√ç' : 'NO'"></span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="space-y-2">
                                                <h6 class="text-sm font-semibold text-gray-700">Coincidencia de Datos:</h6>
                                                <div x-show="step1Result?.data_matches" class="text-sm space-y-1">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Nombre:</span>
                                                        <span :class="step1Result?.data_matches?.name ? 'text-green-600' : 'text-red-600'" class="font-medium flex items-center">
                                                            <i :class="step1Result?.data_matches?.name ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                            <span x-text="step1Result?.data_matches?.name ? 'Coincide' : 'No coincide'"></span>
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Documento:</span>
                                                        <span :class="step1Result?.data_matches?.document_number ? 'text-green-600' : 'text-red-600'" class="font-medium flex items-center">
                                                            <i :class="step1Result?.data_matches?.document_number ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                            <span x-text="step1Result?.data_matches?.document_number ? 'Coincide' : 'No coincide'"></span>
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Fechas:</span>
                                                        <span :class="(step1Result?.data_matches?.birthdate && step1Result?.data_matches?.issue_date && step1Result?.data_matches?.expiry_date) ? 'text-green-600' : 'text-orange-600'" 
                                                              class="font-medium flex items-center">
                                                            <i :class="(step1Result?.data_matches?.birthdate && step1Result?.data_matches?.issue_date && step1Result?.data_matches?.expiry_date) ? 'fas fa-check' : 'fas fa-exclamation-triangle'" class="mr-1"></i>
                                                            <span x-text="(step1Result?.data_matches?.birthdate && step1Result?.data_matches?.issue_date && step1Result?.data_matches?.expiry_date) ? 'Todas correctas' : 'Algunas fallan'"></span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Analysis Message -->
                                        <div x-show="step1Result?.details" class="mt-4 p-3 bg-gray-50 rounded-lg">
                                            <p class="text-sm text-gray-700" x-text="step1Result?.details"></p>
                                        </div>
                                    </div>

                                    <!-- Selfie vs DNI Comparison Results -->
                                    <div class="p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h5 class="font-medium text-gray-800 flex items-center">
                                                    <i class="fas fa-user-check text-green-600 mr-2"></i>
                                                    ü§≥ Verificaci√≥n Facial: DNI vs Selfie (Paso 2)
                                                </h5>
                                                <p class="text-sm text-gray-600">Comparaci√≥n facial entre documento de identidad y selfie</p>
                                            </div>
                                            <div class="text-right">
                                                <span :class="getStatusClass(step2Result?.recommendation)" 
                                                      class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">
                                                    <i :class="getStatusIcon(step2Result?.recommendation)" class="mr-1"></i>
                                                    <span x-text="getStatusText(step2Result?.recommendation)"></span>
                                                </span>
                                                <div class="text-lg font-bold mt-1" 
                                                     :class="getConfidenceClass(step2Result?.confidence)" 
                                                     x-text="`${step2Result?.confidence || 0}%`"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Selfie Analysis Details -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                            <div class="space-y-2">
                                                <h6 class="text-sm font-semibold text-gray-700">An√°lisis Facial:</h6>
                                                <div class="text-sm space-y-1">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Cara detectada en DNI:</span>
                                                        <span :class="step2Result?.face_detected_dni !== false ? 'text-green-600' : 'text-red-600'" class="font-medium flex items-center">
                                                            <i :class="step2Result?.face_detected_dni !== false ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                            <span x-text="step2Result?.face_detected_dni !== false ? 'S√ç' : 'NO'"></span>
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Cara detectada en Selfie:</span>
                                                        <span :class="step2Result?.face_detected_selfie !== false ? 'text-green-600' : 'text-red-600'" class="font-medium flex items-center">
                                                            <i :class="step2Result?.face_detected_selfie !== false ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                            <span x-text="step2Result?.face_detected_selfie !== false ? 'S√ç' : 'NO'"></span>
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Coincidencia facial:</span>
                                                        <span :class="step2Result?.face_match ? 'text-green-600' : 'text-red-600'" class="font-medium flex items-center">
                                                            <i :class="step2Result?.face_match ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                                            <span x-text="step2Result?.face_match ? 'COINCIDE' : 'NO COINCIDE'"></span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="space-y-2">
                                                <h6 class="text-sm font-semibold text-gray-700">Calidad de Im√°genes:</h6>
                                                <div x-show="step2Result?.quality_analysis" class="text-sm space-y-1">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Calidad DNI:</span>
                                                        <span class="font-medium" x-text="`${step2Result?.quality_analysis?.dni_quality || 0}%`"></span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Calidad Selfie:</span>
                                                        <span class="font-medium" x-text="`${step2Result?.quality_analysis?.selfie_quality || 0}%`"></span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Brillo/Contraste:</span>
                                                        <span class="font-medium" x-text="step2Result?.quality_analysis?.lighting_ok ? 'Bueno' : 'Regular'"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Detailed Analysis Message -->
                                        <div x-show="step2Result?.analysis" class="mt-4 p-3 bg-gray-50 rounded-lg">
                                            <p class="text-sm text-gray-700" x-text="step2Result?.analysis"></p>
                                        </div>
                                        
                                        <!-- Fraud Indicators (if any) -->
                                        <div x-show="step2Result?.fraud_indicators && step2Result.fraud_indicators.length > 0" class="mt-4 p-3 bg-red-50 rounded-lg border border-red-200">
                                            <h6 class="text-sm font-semibold text-red-800 mb-2">‚ö†Ô∏è Indicadores de Fraude Detectados:</h6>
                                            <ul class="text-sm text-red-700 space-y-1">
                                                <template x-for="indicator in step2Result.fraud_indicators" :key="indicator">
                                                    <li class="flex items-center">
                                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                                        <span x-text="indicator"></span>
                                                    </li>
                                                </template>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- Liveness Detection Results -->
                                    <div class="p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h5 class="font-medium text-gray-800 flex items-center">
                                                    <i class="fas fa-video text-purple-600 mr-2"></i>
                                                    üé¨ Verificaci√≥n de Vida: Selfie vs Video (Paso 3)
                                                </h5>
                                                <p class="text-sm text-gray-600">An√°lisis de vida real mediante detecci√≥n en video</p>
                                            </div>
                                            <div class="text-right">
                                                <span :class="getStatusClass(step3Result?.recommendation)" 
                                                      class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">
                                                    <i :class="getStatusIcon(step3Result?.recommendation)" class="mr-1"></i>
                                                    <span x-text="getStatusText(step3Result?.recommendation)"></span>
                                                </span>
                                                <div class="text-lg font-bold mt-1" 
                                                     :class="getConfidenceClass(step3Result?.confidence)" 
                                                     x-text="`${step3Result?.confidence || 0}%`"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Liveness Analysis Details -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                            <div class="space-y-2">
                                                <h6 class="text-sm font-semibold text-gray-700">Detecci√≥n de Vida:</h6>
                                                <div class="text-sm space-y-1">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Persona real detectada:</span>
                                                        <span :class="step3Result?.is_live_person ? 'text-green-600' : 'text-red-600'" class="font-medium flex items-center">
                                                            <i :class="step3Result?.is_live_person ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                                            <span x-text="step3Result?.is_live_person ? 'S√ç' : 'NO'"></span>
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Coincide con Selfie:</span>
                                                        <span :class="step3Result?.matches_selfie ? 'text-green-600' : 'text-red-600'" class="font-medium flex items-center">
                                                            <i :class="step3Result?.matches_selfie ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                                                            <span x-text="step3Result?.matches_selfie ? 'COINCIDE' : 'NO COINCIDE'"></span>
                                                        </span>
                                                    </div>
                                                    <div x-show="step3Result?.matches_dni !== undefined" class="flex justify-between">
                                                        <span class="text-gray-600">Coincide con DNI:</span>
                                                        <span :class="step3Result?.matches_dni ? 'text-green-600' : 'text-orange-600'" class="font-medium flex items-center">
                                                            <i :class="step3Result?.matches_dni ? 'fas fa-check' : 'fas fa-exclamation-triangle'" class="mr-1"></i>
                                                            <span x-text="step3Result?.matches_dni ? 'COINCIDE' : 'PARCIAL'"></span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="space-y-2">
                                                <h6 class="text-sm font-semibold text-gray-700">An√°lisis T√©cnico:</h6>
                                                <div x-show="step3Result?.technical_details" class="text-sm space-y-1">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Frames analizados:</span>
                                                        <span class="font-medium" x-text="step3Result?.frames_analyzed || 0"></span>
                                                    </div>
                                                    <div x-show="step3Result?.technical_details?.frames_with_faces" class="flex justify-between">
                                                        <span class="text-gray-600">Frames con caras:</span>
                                                        <span class="font-medium" x-text="step3Result?.technical_details?.frames_with_faces || 0"></span>
                                                    </div>
                                                    <div x-show="step3Result?.technical_details?.detection_rate" class="flex justify-between">
                                                        <span class="text-gray-600">Tasa de detecci√≥n:</span>
                                                        <span class="font-medium" x-text="`${step3Result?.technical_details?.detection_rate || 0}%`"></span>
                                                    </div>
                                                    <div x-show="step3Result?.technical_details?.avg_confidence" class="flex justify-between">
                                                        <span class="text-gray-600">Confianza promedio:</span>
                                                        <span class="font-medium" x-text="`${Math.round(step3Result?.technical_details?.avg_confidence || 0)}%`"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Detailed Analysis Message -->
                                        <div x-show="step3Result?.analysis" class="mt-4 p-3 bg-gray-50 rounded-lg">
                                            <p class="text-sm text-gray-700" x-text="step3Result?.analysis"></p>
                                        </div>
                                        
                                        <!-- Video Processing Info -->
                                        <div x-show="step3Result?.technical_details?.fallback_method" class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                            <h6 class="text-sm font-semibold text-blue-800 mb-2">‚ÑπÔ∏è M√©todo de Procesamiento:</h6>
                                            <div class="text-sm text-blue-700 space-y-1">
                                                <div class="flex justify-between">
                                                    <span>M√©todo usado:</span>
                                                    <span class="font-medium" x-text="getProcessingMethodText(step3Result?.technical_details?.fallback_method)"></span>
                                                </div>
                                                <div x-show="step3Result?.technical_details?.video_size_mb" class="flex justify-between">
                                                    <span>Tama√±o del video:</span>
                                                    <span class="font-medium" x-text="`${step3Result?.technical_details?.video_size_mb} MB`"></span>
                                                </div>
                                                <div x-show="step3Result?.technical_details?.duration_seconds" class="flex justify-between">
                                                    <span>Duraci√≥n:</span>
                                                    <span class="font-medium" x-text="`${step3Result?.technical_details?.duration_seconds}s`"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Debug Information -->
                                <div x-show="verificationResult.debugInfo" class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <h5 class="font-medium text-yellow-800 mb-2">üêõ Informaci√≥n de Debugging:</h5>
                                    <ul class="text-sm text-yellow-700 space-y-1">
                                        <li x-show="verificationResult.debugInfo?.ocrLength">
                                            ‚Ä¢ Caracteres extra√≠dos: <span x-text="verificationResult.debugInfo?.ocrLength"></span>
                                        </li>
                                        <li x-show="verificationResult.debugInfo?.filesUploaded">
                                            ‚Ä¢ Archivos subidos: <span x-text="verificationResult.debugInfo?.filesUploaded"></span>
                                        </li>
                                        <li x-show="verificationResult.debugInfo?.apiErrors">
                                            ‚Ä¢ Errores de API: <span x-text="verificationResult.debugInfo?.apiErrors"></span>
                                        </li>
                                        <li x-show="verificationResult.debugInfo?.processingTime">
                                            ‚Ä¢ Tiempo de procesamiento: <span x-text="verificationResult.debugInfo?.processingTime"></span>ms
                                        </li>
                                    </ul>
                                </div>

                                <!-- Summary -->
                                <div class="mt-6 p-4 rounded-lg border-2" :class="verificationResult.success ? 'bg-green-50 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200'">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center">
                                            <i :class="verificationResult.success ? 'fas fa-shield-check' : 'fas fa-shield-times'" class="text-2xl mr-3"></i>
                                            <div>
                                                <h4 class="text-lg font-bold" x-text="verificationResult.success ? 'VERIFICACI√ìN EXITOSA' : 'VERIFICACI√ìN FALLIDA'"></h4>
                                                <p class="text-sm opacity-90" x-text="verificationResult.message"></p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-3xl font-bold" x-text="`${verificationResult.overallConfidence || 0}%`"></div>
                                            <div class="text-xs opacity-75">Confianza General</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Resumen de pasos -->
                                    <div class="grid grid-cols-3 gap-4 mt-4">
                                        <div class="text-center p-3 bg-white bg-opacity-50 rounded-lg">
                                            <div class="text-lg font-bold mb-1" :class="getConfidenceClass(step1Result?.confidence)" x-text="`${step1Result?.confidence || 0}%`"></div>
                                            <div class="text-xs opacity-75">üìÑ Documento</div>
                                            <div class="text-sm font-medium" x-text="getStatusText(step1Result?.recommendation)"></div>
                                        </div>
                                        <div class="text-center p-3 bg-white bg-opacity-50 rounded-lg">
                                            <div class="text-lg font-bold mb-1" :class="getConfidenceClass(step2Result?.confidence)" x-text="`${step2Result?.confidence || 0}%`"></div>
                                            <div class="text-xs opacity-75">ü§≥ Selfie</div>
                                            <div class="text-sm font-medium" x-text="getStatusText(step2Result?.recommendation)"></div>
                                        </div>
                                        <div class="text-center p-3 bg-white bg-opacity-50 rounded-lg">
                                            <div class="text-lg font-bold mb-1" :class="getConfidenceClass(step3Result?.confidence)" x-text="`${step3Result?.confidence || 0}%`"></div>
                                            <div class="text-xs opacity-75">üé¨ Video</div>
                                            <div class="text-sm font-medium" x-text="getStatusText(step3Result?.recommendation)"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Explicaci√≥n del resultado -->
                                    <div class="mt-4 p-3 bg-white bg-opacity-30 rounded-lg">
                                        <h6 class="font-semibold mb-2">üí° Explicaci√≥n del Resultado:</h6>
                                        <p class="text-sm" x-text="generateResultExplanation()"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="text-center space-x-4">
                                <button @click="restartVerification()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-redo mr-2"></i>Reiniciar Proceso
                                </button>
                                <button x-show="verificationResult.success" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-download mr-2"></i>Descargar Certificado
                                </button>
                            </div>
                        </div>
                    </div>

                    <div x-show="!verifying" class="flex justify-between mt-8">
                        <button @click="previousStep()" class="px-6 py-3 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Anterior
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Messages -->
        <div x-show="errorMessage" 
             class="fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg z-50 max-w-md">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span x-text="errorMessage"></span>
                <button @click="errorMessage = ''" class="ml-4 text-xl">&times;</button>
            </div>
        </div>
    </div>

    <script>
        function kycVerification() {
            return {
                currentStep: 1,
                processing: false,
                errorMessage: '',
                
                // Step 1 Data
                userData: {
                    firstName: '',
                    lastName: '',
                    documentNumber: '',
                    nationality: '',
                    birthDate: '',
                    issueDate: '',
                    expiryDate: ''
                },
                dniPhotoFile: null,
                dniPhotoPreview: null,
                dniPhotoPath: null,
                extractedText: '',
                
                // GPT-4 Smart Analysis Results (legacy)
                gptVerification: null,
                gptExtractedData: null,
                gptDetails: '',
                
                // NUEVO: Step-by-step verification results
                dniValidationPassed: false,
                selfieVerificationPassed: false,
                livenessVerificationPassed: false,
                step1Result: null,
                step2Result: null,
                step3Result: null,
                
                // Step 2 Data
                cameraActive: false,
                selfiePhoto: null,
                faceDetected: false,
                facePosition: null,
                isStable: false,
                readyToCapture: false,
                faceGuide: {
                    x: 0,
                    y: 0,
                    width: 0,
                    height: 0
                },
                faceDetectionInterval: null,
                stabilityCheck: {
                    positions: [],
                    threshold: 10, // pixels
                    requiredFrames: 15 // frames estables requeridos
                },
                
                // Step 3 Data - SIMPLIFICADO
                videoActive: false,
                recording: false,
                recordingTime: '00:00',
                recordedVideo: null,
                mediaRecorder: null,
                recordingTimer: null,
                
                // Sistema simple de instrucciones
                simpleInstructions: [
                    { icon: 'üëÄ', message: 'Mire directamente a la c√°mara' },
                    { icon: '‚ÜîÔ∏è', message: 'Gire la cabeza lentamente a izquierda y derecha' },
                    { icon: 'üòä', message: 'Sonr√≠a de forma natural' }
                ],
                currentInstructionIndex: 0,
                currentMessage: '',
                currentIcon: '',
                progress: 0,
                timeRemaining: 5,
                instructionTimer: null,
                
                // Step 4 Data
                verifying: false,
                processingStep2: false,
                selfieVerificationAttempted: false,
                verificationComplete: false,
                verificationProgress: 0,
                verificationStep: '',
                verificationResult: {
                    success: false,
                    message: '',
                    dniMatch: false,
                    videoMatch: false,
                    dataExtracted: false,
                    dataComparison: null
                },

                init() {
                    console.log('KYC Verification initialized - Sistema Simplificado');
                },



                async nextStep() {
                    // PASO 1: Validar DNI autom√°ticamente
                    if (this.currentStep === 1) {
                        if (!this.canProceedStep1()) {
                            this.showError('Complete todos los campos obligatorios y suba la foto del DNI');
                            return;
                        }
                        
                        // Si no se ha validado a√∫n, hacerlo autom√°ticamente
                        if (!this.dniValidationPassed) {
                            console.log('üöÄ Validando DNI autom√°ticamente...');
                            await this.extractDNIText();
                            
                            // Si la validaci√≥n fall√≥, no continuar
                            if (!this.dniValidationPassed) {
                                this.showError('La validaci√≥n del DNI no fue exitosa. Revise los datos e intente nuevamente.');
                                return;
                            }
                        }
                    }
                    
                    // PASO 2: Validar selfie
                    if (this.currentStep === 2) {
                        if (!this.selfiePhoto) {
                            this.showError('Tome una foto selfie antes de continuar');
                            return;
                        }
                        
                        // Si no se ha verificado el selfie, hacerlo ahora
                        if (!this.selfieVerificationPassed) {
                            console.log('ü§≥ Ejecutando verificaci√≥n de selfie...');
                            await this.verifySelfie();
                            
                            // Si la verificaci√≥n fall√≥, no continuar
                            if (!this.selfieVerificationPassed) {
                                return; // El error ya se muestra en verifySelfie()
                            }
                        }
                    }
                    
                    // PASO 3: Validar video
                    if (this.currentStep === 3 && !this.canProceedStep3()) {
                        this.showError('Complete la verificaci√≥n del video antes de continuar');
                        return;
                    }
                    
                    if (this.currentStep === 3) {
                        this.startVerification();
                    }
                    this.currentStep++;
                },

                previousStep() {
                    if (this.currentStep > 1) {
                        this.currentStep--;
                    }
                },

                // Step 1 Functions
                handleDNIPhoto(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.dniPhotoFile = file;
                        const reader = new FileReader();
                        reader.onload = (e) => this.dniPhotoPreview = e.target.result;
                        reader.readAsDataURL(file);
                    }
                },

                async extractDNIText() {
                    if (!this.dniPhotoFile) return;
                    
                    this.processing = true;
                    try {
                        console.log('üìã PASO 1: Validando DNI con nuevo endpoint modular');
                        
                        // Usar el nuevo endpoint modular /kyc/validate-dni
                        const formData = new FormData();
                        formData.append('firstName', this.userData.firstName);
                        formData.append('lastName', this.userData.lastName);
                        formData.append('documentNumber', this.userData.documentNumber);
                        formData.append('nationality', this.userData.nationality);
                        formData.append('birthDate', this.userData.birthDate);
                        formData.append('issueDate', this.userData.issueDate);
                        formData.append('expiryDate', this.userData.expiryDate);
                        formData.append('dniImageFront', this.dniPhotoFile);
                        
                        const dniResponse = await fetch('/kyc/validate-dni', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!dniResponse.ok) {
                            throw new Error('Error en validaci√≥n de DNI');
                        }
                        
                        const dniResult = await dniResponse.json();
                        console.log('üìã Resultado validaci√≥n DNI:', dniResult);
                        
                        // Guardar resultados del paso 1
                        this.step1Result = dniResult;
                        this.dniPhotoPath = dniResult.dni_front_path;
                        
                        // Determinar si puede pasar al siguiente paso
                        this.dniValidationPassed = dniResult.success && 
                                                   dniResult.recommendation !== 'REJECT' && 
                                                   dniResult.confidence >= 60; // Umbral m√≠nimo
                        
                        if (this.dniValidationPassed) {
                            console.log('‚úÖ DNI validado correctamente - puede continuar');
                            // Solo mostrar texto extra√≠do si es exitoso
                            this.extractedText = dniResult.extracted_text || 'Datos extra√≠dos con GPT-4 Vision';
                            this.showSuccess('DNI validado correctamente. Puede continuar al siguiente paso.');
                            
                            // Guardar datos GPT para mostrar despu√©s
                            this.gptVerification = {
                                name_match: dniResult.data_matches?.name || false,
                                dni_match: dniResult.data_matches?.document_number || false,
                                birthdate_match: dniResult.data_matches?.birthdate || false,
                                address_match: dniResult.data_matches?.address || false,
                                overall_confidence: dniResult.confidence || 0,
                                recommendation: dniResult.recommendation || 'REVIEW'
                            };
                            this.gptExtractedData = dniResult.extracted_data || {};
                            this.gptDetails = dniResult.details || 'An√°lisis completado con GPT-4 Vision';
                        } else {
                            console.log('‚ùå DNI no v√°lido - no puede continuar');
                            
                            // NO mostrar texto extra√≠do en caso de error
                            this.extractedText = '';
                            
                            // Mensaje de error sencillo
                            this.showError('Los datos del documento no coinciden con la informaci√≥n proporcionada. Verifique los datos introducidos o suba una foto m√°s clara del documento.');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error en validaci√≥n DNI:', error);
                        this.showError('Error al validar DNI: ' + error.message);
                        this.dniValidationPassed = false;
                    } finally {
                        this.processing = false;
                    }
                },

                canProceedStep1() {
                    // Solo verificar que los campos b√°sicos est√©n llenos, no la validaci√≥n a√∫n
                    return this.userData.firstName && 
                           this.userData.lastName &&
                           this.userData.documentNumber && 
                           this.userData.nationality &&
                           this.userData.birthDate && 
                           this.userData.issueDate &&
                           this.userData.expiryDate &&
                           this.dniPhotoFile; // Campos b√°sicos obligatorios
                },

                retryDocumentValidation() {
                    // Resetear el estado de validaci√≥n para permitir un nuevo intento
                    this.dniValidationPassed = false;
                    this.step1Result = null;
                    this.extractedText = '';
                    this.errorMessage = '';
                    
                    console.log('üîÑ Estado de validaci√≥n reseteado - listo para nuevo intento');
                },

                // Step 2 Functions
                async startSelfieCamera() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { width: 640, height: 480 } 
                        });
                        this.$refs.selfieVideo.srcObject = stream;
                        this.cameraActive = true;
                    } catch (error) {
                        this.showError('No se pudo acceder a la c√°mara');
                    }
                },

                async takeSelfie() {
                    const video = this.$refs.selfieVideo;
                    const canvas = this.$refs.selfieCanvas;
                    const context = canvas.getContext('2d');
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    context.scale(-1, 1);
                    context.drawImage(video, -canvas.width, 0);
                    
                    this.selfiePhoto = canvas.toDataURL('image/jpeg');
                    this.stopCamera(video);
                    
                    // NUEVO: Verificar autom√°ticamente el selfie con endpoint modular
                    await this.verifySelfie();
                },

                async verifySelfie() {
                    if (!this.selfiePhoto || !this.dniPhotoPath) return;
                    
                    this.processingStep2 = true;
                    this.selfieVerificationAttempted = false;
                    
                    try {
                        console.log('ü§≥ PASO 2: Verificando selfie con nuevo endpoint modular');
                        
                        // Convertir selfie a archivo
                        const selfieFile = this.dataURLtoFile(this.selfiePhoto, 'selfie.jpg');
                        
                        // Usar el nuevo endpoint modular /kyc/verify-selfie
                        const formData = new FormData();
                        formData.append('dniImagePath', this.dniPhotoPath);
                        formData.append('selfieImage', selfieFile);
                        
                        const selfieResponse = await fetch('/kyc/verify-selfie', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!selfieResponse.ok) {
                            throw new Error('Error en verificaci√≥n de selfie');
                        }
                        
                        const selfieResult = await selfieResponse.json();
                        console.log('ü§≥ Resultado verificaci√≥n selfie:', selfieResult);
                        
                        // Guardar resultados del paso 2
                        this.step2Result = selfieResult;
                        
                        // Determinar si puede pasar al siguiente paso (ACEPTA REVIEW tambi√©n)
                        this.selfieVerificationPassed = selfieResult.success && 
                                                       (selfieResult.face_match || 
                                                        selfieResult.recommendation === 'APPROVE' || 
                                                        selfieResult.recommendation === 'REVIEW') && 
                                                       selfieResult.confidence >= 30; // Umbral muy bajo
                        
                        // Marcar que se intent√≥ la verificaci√≥n
                        this.selfieVerificationAttempted = true;
                        
                        if (this.selfieVerificationPassed) {
                            console.log('‚úÖ Selfie verificado correctamente - puede continuar');
                        } else {
                            console.log('‚ùå Selfie no v√°lido - no puede continuar');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error en verificaci√≥n selfie:', error);
                        this.selfieVerificationPassed = false;
                        this.selfieVerificationAttempted = true;
                    } finally {
                        this.processingStep2 = false;
                    }
                },

                retakeSelfie() {
                    this.selfiePhoto = null;
                    this.selfieVerificationPassed = false; // Reset verificaci√≥n
                    this.selfieVerificationAttempted = false; // Reset intento
                    this.step2Result = null;
                    this.startSelfieCamera();
                },

                canProceedStep2() {
                    return this.selfiePhoto && 
                           this.selfieVerificationPassed; // NUEVO: requiere verificaci√≥n exitosa del selfie
                },

                // Step 3 Functions - SIMPLIFICADO
                async startVideoCamera() {
                    try {
                        console.log('üìπ Iniciando c√°mara simple...');
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                width: { ideal: 640, min: 320 },
                                height: { ideal: 480, min: 240 },
                                facingMode: 'user'
                            },
                            audio: false // Sin audio para simplificar
                        });
                        
                        this.$refs.recordVideo.srcObject = stream;
                        this.videoActive = true;
                        console.log('‚úÖ C√°mara simple iniciada correctamente');
                        
                    } catch (error) {
                        console.error('‚ùå Error iniciando c√°mara:', error);
                        let errorMessage = 'No se pudo acceder a la c√°mara';
                        
                        if (error.name === 'NotAllowedError') {
                            errorMessage = 'Permisos de c√°mara denegados. Habilita la c√°mara en tu navegador.';
                        } else if (error.name === 'NotFoundError') {
                            errorMessage = 'No se encontr√≥ ninguna c√°mara conectada.';
                        }
                        
                        this.showError(errorMessage);
                        this.videoActive = false;
                    }
                },

                // NUEVO: Sistema simple de grabaci√≥n sin detecci√≥n compleja
                startRecording() {
                    console.log('üé• Iniciando grabaci√≥n simple...');
                    
                    const stream = this.$refs.recordVideo.srcObject;
                    this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                    const chunks = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) chunks.push(event.data);
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        console.log('üé• Grabaci√≥n completada');
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        this.recordedVideo = URL.createObjectURL(blob);
                    };
                    
                    // Iniciar grabaci√≥n y secuencia simple
                    this.mediaRecorder.start();
                    this.recording = true;
                    this.startRecordingTimer();
                    this.startSimpleSequence();
                },

                // NUEVO: Secuencia simple de 3 instrucciones sin detecci√≥n
                startSimpleSequence() {
                    this.currentInstructionIndex = 0;
                    this.runNextInstruction();
                },

                // NUEVO: Ejecutar siguiente instrucci√≥n simple
                runNextInstruction() {
                    if (this.currentInstructionIndex >= this.simpleInstructions.length) {
                        // Completar grabaci√≥n
                        this.stopRecording();
                        return;
                    }

                    const instruction = this.simpleInstructions[this.currentInstructionIndex];
                    this.currentMessage = instruction.message;
                    this.currentIcon = instruction.icon;
                    this.progress = 0;
                    this.timeRemaining = 5;

                    console.log(`üìã Instrucci√≥n ${this.currentInstructionIndex + 1}: ${instruction.message}`);

                    // Timer de 5 segundos por instrucci√≥n
                    this.instructionTimer = setInterval(() => {
                        this.timeRemaining -= 0.1;
                        this.progress = ((5 - this.timeRemaining) / 5) * 100;

                        if (this.timeRemaining <= 0) {
                            clearInterval(this.instructionTimer);
                            this.currentInstructionIndex++;
                            
                            // Pausa de 0.5 segundos entre instrucciones
                            setTimeout(() => {
                                this.runNextInstruction();
                            }, 500);
                        }
                    }, 100);
                },

                // NUEVO: Parar grabaci√≥n simple
                stopRecording() {
                    console.log('üõë Finalizando grabaci√≥n simple...');
                    
                    if (this.mediaRecorder && this.recording) {
                        this.mediaRecorder.stop();
                        this.recording = false;
                        this.stopRecordingTimer();
                        this.stopCamera(this.$refs.recordVideo);
                        
                        // Limpiar instrucciones
                        this.currentMessage = '';
                        this.currentIcon = '';
                        this.progress = 0;
                        
                        if (this.instructionTimer) {
                            clearInterval(this.instructionTimer);
                            this.instructionTimer = null;
                        }
                        
                        console.log('‚úÖ Grabaci√≥n simple completada');
                        
                        // Procesar autom√°ticamente con backend
                        setTimeout(async () => {
                            await this.verifyLiveness();
                        }, 1000);
                    }
                },

                async verifyLiveness() {
                    if (!this.recordedVideo || !this.selfiePhoto || !this.dniPhotoPath) return;
                    
                    this.processing = true;
                    try {
                        console.log('üé• PASO 3: Verificando liveness con nuevo endpoint modular');
                        
                        // Convertir video blob a archivo
                        const videoBlob = await fetch(this.recordedVideo).then(res => res.blob());
                        const videoFile = new File([videoBlob], 'verification_video.mp4', { type: 'video/mp4' });
                        
                        // Obtener path del selfie (necesario para la verificaci√≥n)
                        const selfieFile = this.dataURLtoFile(this.selfiePhoto, 'selfie.jpg');
                        const selfieFormData = new FormData();
                        selfieFormData.append('image', selfieFile);
                        
                        const selfieUpload = await fetch('/upload', {
                            method: 'POST',
                            body: selfieFormData
                        });
                        
                        if (!selfieUpload.ok) {
                            throw new Error('Error al subir selfie para verificaci√≥n');
                        }
                        
                        const selfieData = await selfieUpload.json();
                        const selfieImagePath = selfieData.path;
                        
                        // Usar el nuevo endpoint modular /kyc/verify-liveness
                        const formData = new FormData();
                        formData.append('selfieImagePath', selfieImagePath);
                        formData.append('dniImagePath', this.dniPhotoPath);
                        formData.append('verificationVideo', videoFile);
                        
                        const livenessResponse = await fetch('/kyc/verify-liveness', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!livenessResponse.ok) {
                            throw new Error('Error en verificaci√≥n de liveness');
                        }
                        
                        const livenessResult = await livenessResponse.json();
                        console.log('üé• Resultado verificaci√≥n liveness:', livenessResult);
                        
                        // Guardar resultados del paso 3
                        this.step3Result = livenessResult;
                        
                        // Determinar si puede pasar al siguiente paso (M√ÅS ESTRICTO)
                        this.livenessVerificationPassed = livenessResult.success && 
                                                          livenessResult.is_live_person && 
                                                          livenessResult.matches_selfie && 
                                                          livenessResult.recommendation === 'APPROVE' &&  // SOLO APPROVE, no REVIEW
                                                          livenessResult.confidence >= 70 &&  // Subido de 60% a 70%
                                                          (!livenessResult.technical_details.detection_rate || 
                                                           livenessResult.technical_details.detection_rate >= 70); // Al menos 70% de frames con caras
                        
                        if (this.livenessVerificationPassed) {
                            console.log('‚úÖ Liveness verificado correctamente - puede continuar');
                            this.showSuccess('Video de vida verificado correctamente. Puede ver el resultado final.');
                        } else {
                            console.log('‚ùå Liveness no v√°lido - no puede continuar');
                            
                            // Mensaje de error m√°s espec√≠fico
                            let errorMessage = `Video no v√°lido: `;
                            let reasons = [];
                            
                            if (!livenessResult.success) {
                                reasons.push('Error en el procesamiento');
                            }
                            if (!livenessResult.is_live_person) {
                                reasons.push('No se detect√≥ persona real');
                            }
                            if (!livenessResult.matches_selfie) {
                                reasons.push('No coincide con el selfie');
                            }
                            if (livenessResult.recommendation === 'REJECT') {
                                reasons.push('Recomendaci√≥n: RECHAZAR');
                            } else if (livenessResult.recommendation === 'REVIEW') {
                                reasons.push('Calidad insuficiente (requiere revisi√≥n)');
                            }
                            if (livenessResult.confidence < 70) {
                                reasons.push(`Confianza muy baja (${livenessResult.confidence}% < 70%)`);
                            }
                            if (livenessResult.technical_details.detection_rate < 70) {
                                reasons.push(`Pocas caras detectadas (${livenessResult.technical_details.detection_rate}% < 70%)`);
                            }
                            
                            errorMessage += reasons.join(', ');
                            errorMessage += '. Por favor, grabe nuevamente asegur√°ndose de mantener su cara visible durante todo el video.';
                            
                            this.showError(errorMessage);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error en verificaci√≥n liveness:', error);
                        this.showError('Error al verificar video: ' + error.message);
                        this.livenessVerificationPassed = false;
                    } finally {
                        this.processing = false;
                    }
                },

                // NUEVO: Funci√≥n simple para repetir video
                retakeVideo() {
                    console.log('üîÑ Reiniciando captura de video simple...');
                    
                    // Limpiar video y estados
                    this.recordedVideo = null;
                    this.livenessVerificationPassed = false;
                    this.step3Result = null;
                    this.processing = false;
                    
                    // Limpiar instrucciones simples
                    this.currentMessage = '';
                    this.currentIcon = '';
                    this.progress = 0;
                    this.currentInstructionIndex = 0;
                    
                    // Limpiar timers
                    if (this.instructionTimer) {
                        clearInterval(this.instructionTimer);
                        this.instructionTimer = null;
                    }
                    
                    // Reiniciar c√°mara
                    this.startVideoCamera();
                },

                getStepClass(step) {
                    if (step < this.currentStep) return 'step-completed';
                    if (step === this.currentStep) return 'step-active';
                    return 'step-inactive';
                },

                canProceedStep3() {
                    return this.recordedVideo && this.livenessVerificationPassed;
                },

                startRecordingTimer() {
                    let seconds = 0;
                    this.recordingTimer = setInterval(() => {
                        seconds++;
                        const mins = Math.floor(seconds / 60);
                        const secs = seconds % 60;
                        this.recordingTime = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    }, 1000);
                },

                stopRecordingTimer() {
                    if (this.recordingTimer) {
                        clearInterval(this.recordingTimer);
                        this.recordingTimer = null;
                    }
                },

                stopCamera(videoElement) {
                    const stream = videoElement.srcObject;
                    if (stream) {
                        const tracks = stream.getTracks();
                        tracks.forEach(track => track.stop());
                        videoElement.srcObject = null;
                    }
                    this.cameraActive = false;
                    this.videoActive = false;
                },

                // Step 4 Functions - NUEVO: Solo muestra resultados de los pasos anteriores
                async startVerification() {
                    console.log('üìä PASO 4: Mostrando resultado final de todos los pasos');
                    
                    this.verifying = true;
                    this.verificationProgress = 0;
                    const verificationStartTime = Date.now();
                    
                    try {
                        // Simular progreso para la animaci√≥n
                        this.verificationStep = 'Recopilando resultados...';
                        this.verificationProgress = 30;
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        this.verificationStep = 'Procesando an√°lisis completo...';
                        this.verificationProgress = 70;
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        this.verificationStep = 'Generando resultado final...';
                        this.verificationProgress = 100;
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Determinar √©xito basado en los 3 pasos previos
                        const dniPassed = this.dniValidationPassed && this.step1Result?.success;
                        const selfiePassed = this.selfieVerificationPassed && this.step2Result?.success;
                        const livenessPassed = this.livenessVerificationPassed && this.step3Result?.success;
                        
                        const allStepsPassed = dniPassed && selfiePassed && livenessPassed;
                        
                        // Calcular confianza promedio de todos los pasos
                        let totalConfidence = 0;
                        let confidenceCount = 0;
                        
                        if (this.step1Result?.confidence) {
                            totalConfidence += this.step1Result.confidence;
                            confidenceCount++;
                        }
                        if (this.step2Result?.confidence) {
                            totalConfidence += this.step2Result.confidence;
                            confidenceCount++;
                        }
                        if (this.step3Result?.confidence) {
                            totalConfidence += this.step3Result.confidence;
                            confidenceCount++;
                        }
                        
                        const overallConfidence = confidenceCount > 0 ? Math.round(totalConfidence / confidenceCount) : 0;
                        
                        // Crear mensaje de error detallado
                        let errorMessage = '';
                        if (!allStepsPassed) {
                            const errors = [];
                            if (!dniPassed) errors.push('Validaci√≥n de DNI fall√≥');
                            if (!selfiePassed) errors.push('Verificaci√≥n de selfie fall√≥');
                            if (!livenessPassed) errors.push('Verificaci√≥n de liveness fall√≥');
                            errorMessage = `Fallos encontrados: ${errors.join(', ')}`;
                        }
                        
                        // Crear comparaci√≥n de datos para mostrar (usar resultado del paso 1)
                        let dataComparison = null;
                        if (this.step1Result && this.step1Result.data_matches) {
                            dataComparison = {
                                name: { 
                                    input: `${this.userData.lastName}, ${this.userData.firstName}`, 
                                    extracted: this.step1Result.extracted_data?.name || 'No extra√≠do', 
                                    match: this.step1Result.data_matches.name 
                                },
                                dni: { 
                                    input: this.userData.dni, 
                                    extracted: this.step1Result.extracted_data?.dni || 'No extra√≠do', 
                                    match: this.step1Result.data_matches.dni 
                                },
                                birthDate: { 
                                    input: this.userData.birthDate, 
                                    extracted: this.step1Result.extracted_data?.birthdate || 'No extra√≠do', 
                                    match: this.step1Result.data_matches.birthdate 
                                },
                                address: { 
                                    input: this.userData.address, 
                                    extracted: this.step1Result.extracted_data?.address || 'No extra√≠do', 
                                    match: this.step1Result.data_matches.address 
                                },
                                matchCount: Object.values(this.step1Result.data_matches).filter(Boolean).length,
                                totalFields: 4,
                                overallMatch: this.step1Result.recommendation !== 'REJECT',
                                summary: this.step1Result.details || `Confianza: ${this.step1Result.confidence}%`
                            };
                        }
                        
                        // Establecer texto extra√≠do del paso 1
                        if (this.step1Result?.extracted_text) {
                            this.extractedText = this.step1Result.extracted_text;
                        }
                        
                        // Resultado final
                        this.verificationResult = {
                            success: allStepsPassed,
                            message: allStepsPassed ? 
                                'Su identidad ha sido verificada exitosamente' : 
                                errorMessage,
                            dniMatch: selfiePassed,  // DNI vs Selfie del paso 2
                            videoMatch: livenessPassed,  // Selfie vs Video del paso 3
                            dataExtracted: dniPassed,  // Extracci√≥n de datos del paso 1
                            
                            // NUEVOS: Datos del paso 1 (document validation)
                            document_analysis: this.step1Result?.document_analysis || {},
                            data_matches: this.step1Result?.data_matches || {},
                            extracted_data: this.step1Result?.extracted_data || {},
                            extracted_text: this.step1Result?.extracted_text || this.extractedText || '',
                            details: this.step1Result?.details || 'Verificaci√≥n completada',
                            
                            dataComparison,
                            overallConfidence,
                            debugInfo: {
                                step1Result: this.step1Result,
                                step2Result: this.step2Result,
                                step3Result: this.step3Result,
                                stepsStatus: `DNI: ${dniPassed ? '‚úì' : '‚úó'}, Selfie: ${selfiePassed ? '‚úì' : '‚úó'}, Liveness: ${livenessPassed ? '‚úì' : '‚úó'}`,
                                processingTime: Date.now() - verificationStartTime
                            }
                        };
                        
                        console.log('üìä Resultado final compilado:', this.verificationResult);
                        
                    } catch (error) {
                        console.error('‚ùå Error compilando resultado final:', error);
                        
                        this.verificationResult = {
                            success: false,
                            message: 'Error procesando resultados finales: ' + error.message,
                            dniMatch: false,
                            videoMatch: false,
                            dataExtracted: false,
                            dataComparison: null,
                            overallConfidence: 0,
                            debugInfo: {
                                error: error.message,
                                processingTime: Date.now() - verificationStartTime
                            }
                        };
                    } finally {
                        this.verifying = false;
                        this.verificationComplete = true;
                    }
                },

                restartVerification() {
                    this.currentStep = 1;
                    this.verifying = false;
                    this.verificationComplete = false;
                    this.verificationProgress = 0;
                    
                    // Reset all data
                    this.userData = { 
                        firstName: '', 
                        lastName: '', 
                        dni: '', 
                        sex: '',
                        birthDate: '', 
                        nationality: 'ESP',
                        address: '' 
                    };
                    this.dniPhotoFile = null;
                    this.dniPhotoPreview = null;
                    this.dniPhotoPath = null;
                    this.extractedText = '';
                    
                    // Reset GPT-4 analysis (legacy)
                    this.gptVerification = null;
                    this.gptExtractedData = null;
                    this.gptDetails = '';
                    
                    // NUEVO: Reset step-by-step verification results
                    this.dniValidationPassed = false;
                    this.selfieVerificationPassed = false;
                    this.livenessVerificationPassed = false;
                    this.step1Result = null;
                    this.step2Result = null;
                    this.step3Result = null;
                    
                    this.selfiePhoto = null;
                    this.recordedVideo = null;
                    
                    // Reset liveness detection
                    this.currentInstruction = null;
                    this.currentInstructionIndex = 0;
                    this.instructionProgress = 0;
                    if (this.instructionTimer) {
                        clearInterval(this.instructionTimer);
                    }
                },

                // NUEVO: Funciones de utilidad para mostrar mensajes
                showSuccess(message) {
                    console.log('‚úÖ √âxito:', message);
                    this.errorMessage = ''; // Limpiar errores previos
                    // Mostrar notificaci√≥n de √©xito temporal (opcional)
                    // TODO: Implementar notificaci√≥n de √©xito visual si se desea
                },

                showError(message) {
                    console.error('‚ùå Error:', message);
                    this.errorMessage = message;
                    // Auto-ocultar despu√©s de 8 segundos
                    setTimeout(() => {
                        this.errorMessage = '';
                    }, 8000);
                },

                createDataComparison() {
                    if (!this.extractedText) {
                        return {
                            name: { input: 'N/A', extracted: 'Sin datos', match: false },
                            dni: { input: 'N/A', extracted: 'Sin datos', match: false },
                            birthDate: { input: 'N/A', extracted: 'Sin datos', match: false },
                            address: { input: 'N/A', extracted: 'Sin datos', match: false },
                            matchCount: 0,
                            totalFields: 4,
                            overallMatch: false,
                            summary: 'No se pudieron extraer datos del DNI para comparar'
                        };
                    }

                    const extractedText = this.extractedText.toUpperCase();
                    
                    // Extract data from OCR text
                    const extractedData = {
                        name: this.extractNameFromOCR(extractedText),
                        dni: this.extractDNIFromOCR(extractedText),
                        birthDate: this.extractBirthDateFromOCR(extractedText),
                        address: this.extractAddressFromOCR(extractedText)
                    };

                    // User input data (formatted for comparison)
                    const inputData = {
                        name: `${this.userData.lastName}, ${this.userData.firstName}`.toUpperCase(),
                        dni: this.userData.dni.toUpperCase(),
                        birthDate: this.formatBirthDate(this.userData.birthDate),
                        address: this.userData.address.toUpperCase()
                    };

                    // Compare each field
                    const comparison = {
                        name: {
                            input: inputData.name,
                            extracted: extractedData.name,
                            match: this.compareNames(inputData.name, extractedData.name)
                        },
                        dni: {
                            input: inputData.dni,
                            extracted: extractedData.dni,
                            match: this.compareDNI(inputData.dni, extractedData.dni)
                        },
                        birthDate: {
                            input: inputData.birthDate,
                            extracted: extractedData.birthDate,
                            match: this.compareBirthDate(inputData.birthDate, extractedData.birthDate)
                        },
                        address: {
                            input: inputData.address,
                            extracted: extractedData.address,
                            match: this.compareAddress(inputData.address, extractedData.address)
                        }
                    };

                    // Calculate overall match
                    const matches = Object.values(comparison).filter(field => field.match);
                    const matchCount = matches.length;
                    const totalFields = 4;
                    const overallMatch = matchCount >= 3; // At least 3 out of 4 fields must match

                    return {
                        ...comparison,
                        matchCount,
                        totalFields,
                        overallMatch,
                        summary: overallMatch ? 
                            `Excelente: ${matchCount} de ${totalFields} campos coinciden` :
                            `Problema: Solo ${matchCount} de ${totalFields} campos coinciden`
                    };
                },

                extractNameFromOCR(text) {
                    // Look for name patterns in Spanish DNI
                    const lines = text.split(/\n|\r/);
                    let apellidos = '';
                    let nombre = '';
                    
                    // Find apellidos (usually before NOMBRE/NOM line)
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        // Skip empty lines and lines with numbers/symbols
                        if (!line || /\d/.test(line) || /[~¬Æ¬©]/.test(line) || line.length < 3) continue;
                        
                        // Check if next line contains NOMBRE
                        const nextLine = lines[i + 1] ? lines[i + 1].trim() : '';
                        if (nextLine.includes('NOMBRE') || nextLine.includes('NOM')) {
                            apellidos = line;
                            break;
                        }
                        
                        // Also check if this looks like a surname (all caps, no special chars)
                        if (/^[A-Z√Å√â√ç√ì√ö√ë\s]+$/.test(line) && line.length > 2 && line.length < 30) {
                            // Check if it's not a common DNI word
                            if (!line.includes('REINO') && !line.includes('ESPANA') && !line.includes('SEXO') && 
                                !line.includes('NACIONALIDAD') && !line.includes('IDENTITY')) {
                                apellidos = line;
                            }
                        }
                    }
                    
                    // Find nombre (usually after NOMBRE/NOM line)
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.includes('NOMBRE') || line.includes('NOM')) {
                            // Check next line for the actual name
                            const nextLine = lines[i + 1] ? lines[i + 1].trim() : '';
                            if (nextLine && /^[A-Z√Å√â√ç√ì√ö√ë\s]+$/.test(nextLine) && nextLine.length > 1 && nextLine.length < 20) {
                                nombre = nextLine;
                                break;
                            }
                        }
                    }
                    
                    if (apellidos && nombre) {
                        return `${apellidos}, ${nombre}`;
                    } else if (apellidos) {
                        return apellidos;
                    } else if (nombre) {
                        return nombre;
                    }
                    
                    return 'No encontrado en DNI';
                },

                extractDNIFromOCR(text) {
                    // Look for DNI number patterns in Spanish DNI
                    const dniPatterns = [
                        /(\d{8}[A-Z])/g,  // 12345678X (most common)
                        /(\d{8}\s*[A-Z])/g,  // 12345678 X (with space)
                        /[^\d]*(\d{8})[^\d\s]*([A-Z])/g,  // ~12345678GE¬Æ (with junk around)
                        /DNI[:\s]*(\d{8}[A-Z])/g,
                        /(\d{8}-[A-Z])/g  // 12345678-X
                    ];
                    
                    for (const pattern of dniPatterns) {
                        let match;
                        while ((match = pattern.exec(text)) !== null) {
                            if (match[1] && match[2]) {
                                // Pattern with separated numbers and letter
                                const dni = match[1] + match[2];
                                if (dni.length === 9) return dni;
                            } else if (match[1]) {
                                // Pattern with combined number and letter
                                const dni = match[1].replace(/[-\s]/g, '');
                                if (dni.length === 9 && /^\d{8}[A-Z]$/.test(dni)) {
                                    return dni;
                                }
                            }
                        }
                        pattern.lastIndex = 0; // Reset regex
                    }
                    
                    // Try to find 8 digits followed by a letter anywhere in text
                    const fallbackMatch = text.match(/(\d{8})[^\d]*([A-Z])/);
                    if (fallbackMatch) {
                        return fallbackMatch[1] + fallbackMatch[2];
                    }
                    
                    return 'No encontrado en DNI';
                },

                extractBirthDateFromOCR(text) {
                    // Look for birth date patterns in Spanish DNI
                    const datePatterns = [
                        /NACIMIENTO[:\s\/]*(\d{2}[\s\/\-]\d{2}[\s\/\-]\d{4})/i,  // NACIMIENTO 06 03 1994
                        /NAIXEMENT[:\s\/]*(\d{2}[\s\/\-]\d{2}[\s\/\-]\d{4})/i,   // Catalan version
                        /(\d{2}\s+\d{2}\s+\d{4})/g,  // 06 03 1994 (spaces)
                        /(\d{2}[\/\-]\d{2}[\/\-]\d{4})/g,  // 06/03/1994 or 06-03-1994
                        /(\d{1,2}\s+\d{1,2}\s+\d{4})/g  // 6 3 1994 (single digits)
                    ];
                    
                    for (const pattern of datePatterns) {
                        let match;
                        if (pattern.global) {
                            while ((match = pattern.exec(text)) !== null) {
                                let dateStr = match[1];
                                // Normalize date format
                                dateStr = dateStr.replace(/\s+/g, '/').replace(/-/g, '/');
                                
                                // Validate it looks like a reasonable birth date
                                const parts = dateStr.split('/');
                                if (parts.length === 3) {
                                    const day = parseInt(parts[0]);
                                    const month = parseInt(parts[1]);
                                    const year = parseInt(parts[2]);
                                    
                                    // Basic validation: reasonable birth year and valid day/month ranges
                                    if (year >= 1920 && year <= 2010 && 
                                        day >= 1 && day <= 31 && 
                                        month >= 1 && month <= 12) {
                                        return dateStr;
                                    }
                                }
                            }
                            pattern.lastIndex = 0; // Reset regex
                        } else {
                            match = text.match(pattern);
                            if (match) {
                                let dateStr = match[1];
                                dateStr = dateStr.replace(/\s+/g, '/').replace(/-/g, '/');
                                return dateStr;
                            }
                        }
                    }
                    
                    return 'No encontrado en DNI';
                },

                extractAddressFromOCR(text) {
                    // Look for address patterns in Spanish DNI
                    const addressPatterns = [
                        /DOMICILIO[:\s]*([A-Z√Å√â√ç√ì√ö√ë0-9\s,.-]+?)(?=\n|\r|FECHA|EXPEDICI√ìN|VALIDEZ|$)/i,
                        /DIRECCI√ìN[:\s]*([A-Z√Å√â√ç√ì√ö√ë0-9\s,.-]+?)(?=\n|\r|FECHA|EXPEDICI√ìN|VALIDEZ|$)/i,
                        /DIRECCI√ì[:\s]*([A-Z√Å√â√ç√ì√ö√ë0-9\s,.-]+?)(?=\n|\r|FECHA|EXPEDICI√ì|VALIDESA|$)/i,  // Catalan
                        /CALLE[:\s]*([A-Z√Å√â√ç√ì√ö√ë0-9\s,.-]+?)(?=\n|\r|FECHA|EXPEDICI√ìN|VALIDEZ|$)/i,
                        /CARRER[:\s]*([A-Z√Å√â√ç√ì√ö√ë0-9\s,.-]+?)(?=\n|\r|FECHA|EXPEDICI√ì|VALIDESA|$)/i,  // Catalan
                        /AVENIDA[:\s]*([A-Z√Å√â√ç√ì√ö√ë0-9\s,.-]+?)(?=\n|\r|FECHA|EXPEDICI√ìN|VALIDEZ|$)/i,
                        /PLAZA[:\s]*([A-Z√Å√â√ç√ì√ö√ë0-9\s,.-]+?)(?=\n|\r|FECHA|EXPEDICI√ìN|VALIDEZ|$)/i
                    ];
                    
                    for (const pattern of addressPatterns) {
                        const match = text.match(pattern);
                        if (match && match[1]) {
                            const address = match[1].trim();
                            // Filter out very short or obviously wrong matches
                            if (address.length > 5 && !address.includes('FECHA') && !address.includes('EXPEDICI√ìN')) {
                                return address;
                            }
                        }
                    }
                    
                    // Some DNI don't show full address, look for patterns like street names
                    const lines = text.split(/\n|\r/);
                    for (const line of lines) {
                        const trimmed = line.trim();
                        // Look for lines that might be addresses (contain numbers and letters, reasonable length)
                        if (/^[A-Z√Å√â√ç√ì√ö√ë\s]+\s+\d+/.test(trimmed) && trimmed.length > 10 && trimmed.length < 60) {
                            // Make sure it's not a date or DNI number
                            if (!/\d{8}/.test(trimmed) && !/\d{2}\s+\d{2}\s+\d{4}/.test(trimmed)) {
                                return trimmed;
                            }
                        }
                    }
                    
                    return 'No encontrado en DNI';
                },

                formatBirthDate(dateString) {
                    if (!dateString) return 'No proporcionado';
                    
                    try {
                        const date = new Date(dateString);
                        const day = date.getDate().toString().padStart(2, '0');
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    } catch {
                        return dateString;
                    }
                },

                compareNames(input, extracted) {
                    if (!input || !extracted || extracted === 'No encontrado en DNI') return false;
                    
                    // Remove special characters and extra spaces
                    const cleanInput = input.replace(/[^A-Z√Å√â√ç√ì√ö√ë\s]/g, '').replace(/\s+/g, ' ').trim().toUpperCase();
                    const cleanExtracted = extracted.replace(/[^A-Z√Å√â√ç√ì√ö√ë\s]/g, '').replace(/\s+/g, ' ').trim().toUpperCase();
                    
                    // Split names into parts
                    const inputParts = cleanInput.split(/[,\s]+/).filter(part => part.length > 1);
                    const extractedParts = cleanExtracted.split(/[,\s]+/).filter(part => part.length > 1);
                    
                    // Check if there's significant overlap between name parts
                    let matches = 0;
                    for (const inputPart of inputParts) {
                        for (const extractedPart of extractedParts) {
                            if (inputPart === extractedPart || 
                                inputPart.includes(extractedPart) || 
                                extractedPart.includes(inputPart) ||
                                this.calculateSimilarity(inputPart, extractedPart) > 0.85) {
                                matches++;
                                break;
                            }
                        }
                    }
                    
                    // Consider it a match if at least 50% of the input parts have a match
                    const matchRatio = matches / Math.max(inputParts.length, 1);
                    
                    // Also check direct similarity as fallback
                    const directSimilarity = this.calculateSimilarity(cleanInput, cleanExtracted);
                    
                    return matchRatio >= 0.5 || directSimilarity > 0.7;
                },

                compareDNI(input, extracted) {
                    if (!input || !extracted || extracted === 'No encontrado en DNI') return false;
                    
                    const cleanInput = input.replace(/[^0-9A-Z]/g, '').toUpperCase();
                    const cleanExtracted = extracted.replace(/[^0-9A-Z]/g, '').toUpperCase();
                    
                    // Exact match is preferred
                    if (cleanInput === cleanExtracted) return true;
                    
                    // If both are 9 characters (8 digits + letter), check similarity
                    if (cleanInput.length === 9 && cleanExtracted.length === 9) {
                        // Check if the letter matches (most important part)
                        const inputLetter = cleanInput.slice(-1);
                        const extractedLetter = cleanExtracted.slice(-1);
                        
                        // Check if the numbers are similar (allow 1-2 character differences for OCR errors)
                        const inputNumbers = cleanInput.slice(0, 8);
                        const extractedNumbers = cleanExtracted.slice(0, 8);
                        
                        const numberSimilarity = this.calculateSimilarity(inputNumbers, extractedNumbers);
                        
                        // Accept if letter matches and numbers are very similar (>87.5% = max 1 digit different)
                        return inputLetter === extractedLetter && numberSimilarity >= 0.875;
                    }
                    
                    // For other cases, check if one contains the other (partial matches)
                    return cleanInput.includes(cleanExtracted) || cleanExtracted.includes(cleanInput);
                },

                compareBirthDate(input, extracted) {
                    if (!input || !extracted || extracted === 'No encontrado en DNI') return false;
                    
                    // Normalize date formats
                    const normalizeDate = (date) => {
                        return date.replace(/[-\s]/g, '/').replace(/\/+/g, '/');
                    };
                    
                    const normalizedInput = normalizeDate(input);
                    const normalizedExtracted = normalizeDate(extracted);
                    
                    // Direct match
                    if (normalizedInput === normalizedExtracted) return true;
                    
                    // Parse dates to compare components
                    const parseDate = (dateStr) => {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            return {
                                day: parseInt(parts[0]),
                                month: parseInt(parts[1]),
                                year: parseInt(parts[2])
                            };
                        }
                        return null;
                    };
                    
                    const inputDate = parseDate(normalizedInput);
                    const extractedDate = parseDate(normalizedExtracted);
                    
                    // Compare individual components (allows for minor OCR errors)
                    if (inputDate && extractedDate) {
                        return inputDate.day === extractedDate.day &&
                               inputDate.month === extractedDate.month &&
                               inputDate.year === extractedDate.year;
                    }
                    
                    // Fallback: check if the strings are very similar
                    return this.calculateSimilarity(normalizedInput, normalizedExtracted) > 0.9;
                },

                compareAddress(input, extracted) {
                    if (!input || !extracted || extracted === 'No encontrado en DNI') return false;
                    
                    // For address, we use similarity matching since OCR might not be perfect
                    const cleanInput = input.replace(/[^A-Z√Å√â√ç√ì√ö√ë0-9\s]/g, '').replace(/\s+/g, ' ').trim();
                    const cleanExtracted = extracted.replace(/[^A-Z√Å√â√ç√ì√ö√ë0-9\s]/g, '').replace(/\s+/g, ' ').trim();
                    
                    return this.calculateSimilarity(cleanInput, cleanExtracted) > 0.6; // 60% similarity
                },

                calculateSimilarity(str1, str2) {
                    if (str1.length === 0 && str2.length === 0) return 1;
                    if (str1.length === 0 || str2.length === 0) return 0;
                    
                    const longer = str1.length > str2.length ? str1 : str2;
                    const shorter = str1.length > str2.length ? str2 : str1;
                    
                    if (longer.length === 0) return 1;
                    
                    const distance = this.levenshteinDistance(longer, shorter);
                    return (longer.length - distance) / longer.length;
                },

                levenshteinDistance(str1, str2) {
                    const matrix = Array(str2.length + 1).fill().map(() => Array(str1.length + 1).fill(0));
                    
                    for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
                    for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;
                    
                    for (let j = 1; j <= str2.length; j++) {
                        for (let i = 1; i <= str1.length; i++) {
                            const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                            matrix[j][i] = Math.min(
                                matrix[j][i - 1] + 1,
                                matrix[j - 1][i] + 1,
                                matrix[j - 1][i - 1] + cost
                            );
                        }
                    }
                    
                    return matrix[str2.length][str1.length];
                },

                showError(message) {
                    this.errorMessage = message;
                    setTimeout(() => this.errorMessage = '', 5000);
                },

                // Utility function to convert data URL to File
                dataURLtoFile(dataurl, filename) {
                    if (!dataurl) return null;
                    
                    // Note: blob URLs are handled separately in async context
                    if (dataurl.startsWith('blob:')) {
                        throw new Error('Blob URLs should be handled asynchronously');
                    }
                    
                    // Handle data URLs (for images)
                    try {
                        const arr = dataurl.split(',');
                        const mime = arr[0].match(/:(.*?);/)[1];
                        const bstr = atob(arr[1]);
                        let n = bstr.length;
                        const u8arr = new Uint8Array(n);
                        while (n--) {
                            u8arr[n] = bstr.charCodeAt(n);
                        }
                        return new File([u8arr], filename, { type: mime });
                    } catch (error) {
                        console.error('Error converting dataURL to File:', error);
                        return null;
                    }
                },
                
                // Utility function for delays
                delay(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                },

                // NUEVO: Funciones para formatear estados y colores en resultados
                getStatusClass(recommendation) {
                    switch(recommendation) {
                        case 'APPROVE':
                            return 'bg-green-100 text-green-800 border border-green-200';
                        case 'REVIEW':
                            return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                        case 'REJECT':
                            return 'bg-red-100 text-red-800 border border-red-200';
                        default:
                            return 'bg-gray-100 text-gray-800 border border-gray-200';
                    }
                },

                getStatusIcon(recommendation) {
                    switch(recommendation) {
                        case 'APPROVE':
                            return 'fas fa-check-circle';
                        case 'REVIEW':
                            return 'fas fa-exclamation-triangle';
                        case 'REJECT':
                            return 'fas fa-times-circle';
                        default:
                            return 'fas fa-question-circle';
                    }
                },

                getStatusText(recommendation) {
                    switch(recommendation) {
                        case 'APPROVE':
                            return 'APROBADO';
                        case 'REVIEW':
                            return 'REVISI√ìN';
                        case 'REJECT':
                            return 'DENEGADO';
                        default:
                            return 'PENDIENTE';
                    }
                },

                getConfidenceClass(confidence) {
                    if (!confidence) return 'text-gray-500';
                    if (confidence >= 70) return 'text-green-600';
                    if (confidence >= 50) return 'text-yellow-600';
                    return 'text-red-600';
                },

                getProcessingMethodText(method) {
                    switch(method) {
                        case 'frame_analysis':
                            return 'An√°lisis de frames extra√≠dos';
                        case 'size_and_duration_analysis':
                            return 'An√°lisis por duraci√≥n y tama√±o';
                        case 'size_only_analysis':
                            return 'An√°lisis por tama√±o √∫nicamente';
                        default:
                            return 'An√°lisis est√°ndar';
                    }
                },

                generateResultExplanation() {
                    const dni = this.step1Result;
                    const selfie = this.step2Result;
                    const liveness = this.step3Result;
                    
                    let explanations = [];
                    
                    // An√°lisis del documento
                    if (dni?.recommendation === 'APPROVE') {
                        explanations.push(`‚úÖ El documento es v√°lido y todos los datos coinciden (${dni.confidence}%)`);
                    } else if (dni?.recommendation === 'REVIEW') {
                        explanations.push(`‚ö†Ô∏è El documento es v√°lido pero algunos datos necesitan revisi√≥n (${dni.confidence}%)`);
                    } else {
                        explanations.push(`‚ùå El documento tiene problemas de validaci√≥n (${dni?.confidence || 0}%)`);
                    }
                    
                    // An√°lisis del selfie
                    if (selfie?.face_match && selfie?.recommendation === 'APPROVE') {
                        explanations.push(`‚úÖ La cara del selfie coincide perfectamente con el DNI (${selfie.confidence}%)`);
                    } else if (selfie?.face_match && selfie?.recommendation === 'REVIEW') {
                        explanations.push(`‚ö†Ô∏è La cara del selfie tiene similitud parcial con el DNI (${selfie.confidence}%)`);
                    } else {
                        explanations.push(`‚ùå La cara del selfie no coincide con el DNI (${selfie?.confidence || 0}%)`);
                    }
                    
                    // An√°lisis del video
                    if (liveness?.is_live_person && liveness?.matches_selfie && liveness?.recommendation === 'APPROVE') {
                        explanations.push(`‚úÖ Se detect√≥ persona real en el video que coincide con el selfie (${liveness.confidence}%)`);
                    } else if (liveness?.is_live_person && liveness?.recommendation === 'REVIEW') {
                        explanations.push(`‚ö†Ô∏è Se detect√≥ persona real pero con coincidencia parcial (${liveness.confidence}%)`);
                    } else {
                        explanations.push(`‚ùå No se pudo verificar vida real o no coincide con el selfie (${liveness?.confidence || 0}%)`);
                    }
                    
                    // Conclusi√≥n
                    const allApproved = dni?.recommendation === 'APPROVE' && selfie?.recommendation === 'APPROVE' && liveness?.recommendation === 'APPROVE';
                    const hasReview = dni?.recommendation === 'REVIEW' || selfie?.recommendation === 'REVIEW' || liveness?.recommendation === 'REVIEW';
                    
                    if (allApproved) {
                        explanations.push('üéâ Todos los pasos pasaron exitosamente. Verificaci√≥n completa.');
                    } else if (hasReview) {
                        explanations.push('üîç Algunos pasos requieren revisi√≥n manual por un operador.');
                    } else {
                        explanations.push('üö´ La verificaci√≥n fall√≥ en uno o m√°s pasos cr√≠ticos.');
                    }
                    
                    return explanations.join(' ');
                }
            }
        }
    </script>
</body>
</html>
